<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nova Solar Energy Calculator (MY â€“ TNB)</title>
  <style>
    :root{
      --primary:#2563eb; --primary-600:#1d4ed8;
      --bg:#0b1020; --panel:#0f172a;
      --text:#e5e7eb; --muted:#9ca3af; --ok:#22c55e; --warn:#f97316;
      --chip:#1f2937; --card:#0b1222;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 500px at 20% -20%, #0b3b7e33, transparent),
                  radial-gradient(900px 400px at 120% 20%, #0ea5e980, transparent),
                  var(--bg);
      color:var(--text);
    }
    header{padding:28px 16px; text-align:center}
    header h1{margin:0;font-size:28px;letter-spacing:.3px}
    header p{margin:8px 0 0;color:var(--muted)}
    .wrap{max-width:1040px;margin:0 auto;padding:16px}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12; background:linear-gradient(180deg,#0c142a,#0b1222);
      border:1px solid #1e293b; border-radius:14px; padding:18px;
      box-shadow:0 12px 32px rgba(0,0,0,.35), inset 0 1px 0 #1e293b}
    @media (min-width:900px){ .span-7{grid-column:span 7} .span-5{grid-column:span 5} }
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media (min-width:680px){ .row{grid-template-columns:repeat(2,1fr)} }
    label{font-size:13px;color:var(--muted)}
    input, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155;
      background:#0b1222; color:var(--text); outline:none;
    }
    input:focus, select:focus{border-color:#60a5fa; box-shadow:0 0 0 3px #1d4ed833}
    .tabs{display:flex; background:#0b1222; border:1px solid #334155; border-radius:12px; padding:4px; gap:4px}
    .tabs button{flex:1; padding:10px 12px; border:0; border-radius:10px; cursor:pointer; color:var(--text); background:transparent; transition:.15s}
    .tabs button.active{background:var(--primary)}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{background:var(--chip); color:#cbd5e1; padding:6px 10px; border-radius:999px; font-size:12px}
    .btn{width:100%; padding:12px 14px; border-radius:12px; border:0; cursor:pointer; background:var(--primary); color:white; font-weight:600; letter-spacing:.2px}
    .btn:hover{background:var(--primary-600)}
    .kpi{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:10px}
    .kcard{background:#0b1222; border:1px solid #1f2937; border-radius:12px; padding:12px}
    .kcard h3{margin:0 0 4px;font-size:14px;color:#9aa4b2}
    .big{font-size:22px;font-weight:700}
    .muted{color:var(--muted)}
    .good{color:var(--ok)} .warn{color:var(--warn)}
    .hr{height:1px;background:#1f2937;margin:14px 0}
    small.note{color:#94a3b8}
    footer{padding:20px; text-align:center; color:#64748b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <header>
    <h1>Nova Solar Energy Calculator â€” Malaysia (TNB)</h1>
    <p>å®¹é‡ã€é€†è®Šå™¨ã€å„²èƒ½é…ç½® + TNBï¼ˆNormal / ToU / NEMï¼‰ç¯€çœä¼°ç®—</p>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- å·¦å´ï¼šè¼¸å…¥ -->
      <section class="card span-7">
        <div class="chips">
          <span class="chip">ğŸ‡²ğŸ‡¾ TNB</span>
          <span class="chip">Domestic (General / ToU)</span>
          <span class="chip">NEM è‡ªç”¨ + å›é¥‹ï¼ˆç°¡åŒ–ï¼‰</span>
        </div>

        <h2 style="margin:10px 0 8px">é›»åƒ¹æ¨¡å¼</h2>
        <div class="tabs" role="tablist" aria-label="Tariff Mode">
          <button id="tab-normal" class="active" onclick="setTariff('NORMAL')">Normal</button>
          <button id="tab-tou" onclick="setTariff('TOU')">ToU</button>
          <button id="tab-nem" onclick="setTariff('NEM')">NEM</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label for="monthlyUsage">æ¯æœˆç¸½ç”¨é›»é‡ (kWh)</label>
            <input id="monthlyUsage" type="number" placeholder="ä¾‹å¦‚ 900" value="900" min="1" />
          </div>
          <div>
            <label for="dayRatio">ç™½å¤©ç”¨é›»æ¯”ä¾‹ (%)</label>
            <input id="dayRatio" type="number" placeholder="ä¾‹å¦‚ 70" value="70" min="0" max="100" />
          </div>
        </div>

        <div id="touRow" class="row" style="margin-top:10px; display:none">
          <div>
            <label for="peakRatio">ï¼ˆToUï¼‰å³°æ™‚ç”¨é›»æ¯”ä¾‹ (%)</label>
            <input id="peakRatio" type="number" placeholder="ä¾‹å¦‚ 40" value="40" min="0" max="100" />
          </div>
          <div>
            <label>èªªæ˜</label>
            <input disabled value="é›¢å³° = 100 - å³°æ™‚" />
          </div>
        </div>

        <h2 style="margin:16px 0 8px">ç³»çµ±å‡è¨­</h2>
        <div class="row">
          <div>
            <label for="sunlightHours">æ—¥ç…§å°æ™‚ (h/day)</label>
            <input id="sunlightHours" type="number" step="0.1" value="4.5" min="1" max="8" />
          </div>
          <div>
            <label for="solarEff">PV ç³»çµ±æ•ˆç‡ (%)</label>
            <input id="solarEff" type="number" value="80" min="60" max="98" />
          </div>
          <div>
            <label for="batteryUse">æ˜¯å¦ä½¿ç”¨å„²èƒ½é›»æ± ï¼Ÿ</label>
            <select id="batteryUse" onchange="toggleBattery()">
              <option value="no" selected>å¦</option>
              <option value="yes">æ˜¯</option>
            </select>
          </div>
          <div id="batEffBox" style="display:none">
            <label for="batteryEff">é›»æ± å¾€è¿”æ•ˆç‡ (%)</label>
            <input id="batteryEff" type="number" value="90" min="60" max="99" />
          </div>
        </div>

        <div class="hr"></div>
        <button class="btn" id="calcBtn">é–‹å§‹è¨ˆç®—</button>
        <small class="note">
          *å·¥ç¨‹é ä¼°ï¼šæ”¶è²»å¸¸æ•¸ä»¥å…¬é–‹è³‡æ–™ç°¡åŒ–ï¼›æœ€çµ‚å¸³å–®ä»¥ TNB ç•¶æœŸå…¬å‘Šç‚ºæº–ã€‚
        </small>
      </section>

      <!-- å³å´ï¼šè¼¸å‡º -->
      <section class="card span-5" id="outCard">
        <h2 style="margin:0 0 8px">çµæœ</h2>
        <div class="kpi">
          <div class="kcard">
            <h3>å¤ªé™½èƒ½å®¹é‡</h3>
            <div class="big" id="outCap">â€”</div>
            <div class="muted">kW</div>
          </div>
          <div class="kcard">
            <h3>é€†è®Šå™¨å»ºè­°</h3>
            <div class="big" id="outInv">â€”</div>
            <div class="muted">kW</div>
          </div>
          <div class="kcard">
            <h3>é›»æ± å®¹é‡</h3>
            <div class="big" id="outBat">â€”</div>
            <div class="muted">kWhï¼ˆå¤œç”¨+20%ï¼‰</div>
          </div>
          <div class="kcard">
            <h3>åŸå§‹æœˆé›»è²»</h3>
            <div class="big" id="outBill0">â€”</div>
            <div class="muted">RM</div>
          </div>
          <div class="kcard">
            <h3>å®‰è£å¾Œæœˆé›»è²»</h3>
            <div class="big" id="outBill1">â€”</div>
            <div class="muted">RM</div>
          </div>
          <div class="kcard">
            <h3>é ä¼°æœˆç¯€çœ</h3>
            <div class="big good" id="outSave">â€”</div>
            <div class="muted">RM</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="mono" style="font-size:12px; line-height:1.5" id="debug"></div>
      </section>
    </div>
  </div>

  <footer>Â© Nova â€” Prototype for Malaysia (TNB) | HTML+CSS+JS</footer>

  <script>
    // ====== UI åˆ‡æ› ======
    let TARIFF = 'NORMAL'; // NORMAL | TOU | NEM
    function setTariff(mode){
      TARIFF = mode;
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      document.getElementById('tab-normal').classList.toggle('active', mode==='NORMAL');
      document.getElementById('tab-tou').classList.toggle('active', mode==='TOU');
      document.getElementById('tab-nem').classList.toggle('active', mode==='NEM');
      document.getElementById('touRow').style.display = (mode==='TOU') ? 'grid' : 'none';
    }
    function toggleBattery(){
      const v = document.getElementById('batteryUse').value;
      document.getElementById('batEffBox').style.display = v==='yes' ? 'block' : 'none';
    }

    // ====== å·¥å…· ======
    const round2 = n => Math.round(n*100)/100;
    const fmtRM = n => 'RM ' + (round2(n)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});

    // TNB ç°¡åŒ–è²»ç‡ï¼ˆsen/kWh; RM = sen/100ï¼‰
    function getRates(monthlyKWh){
      const under1500 = monthlyKWh <= 1500;
      return {
        energy: under1500 ? 27.03 : 37.03,
        capacity: 4.55,
        network: 12.85,
        retailRM: monthlyKWh <= 600 ? 0 : 10,
        peak: under1500 ? 28.52 : 38.52,     // ToU
        offpeak: under1500 ? 24.43 : 34.43, // ToU
        AFA: 0
      };
    }

    // è¨ˆç®—å¸³å–®ï¼ˆç°¡åŒ–ï¼‰ï¼šå‚³å…¥è¦å‘é›»ç¶²è³¼é›»çš„ kWh
    function billRM(kWh, mode, rates, peakRatio){
      let energySen = 0;
      if(mode === 'TOU'){
        const pk = kWh * (peakRatio ?? 0);
        const op = kWh - pk;
        energySen = pk * rates.peak + op * rates.offpeak;
      }else{
        energySen = kWh * rates.energy;
      }
      const nonEnergySen = kWh * (rates.capacity + rates.network + rates.AFA);
      return energySen/100 + nonEnergySen/100 + rates.retailRM;
    }

    // ====== ä¸»è¨ˆç®— ======
    function run(){
      const m = id => document.getElementById(id);
      const monthly = parseFloat(m('monthlyUsage').value);
      const dayPct  = parseFloat(m('dayRatio').value)/100;
      const peakPct = parseFloat(m('peakRatio').value || '0')/100;
      const sunH    = parseFloat(m('sunlightHours').value);
      const pvEff   = parseFloat(m('solarEff').value)/100;
      const useBat  = m('batteryUse').value==='yes';
      const batEff  = useBat ? (parseFloat(m('batteryEff').value)/100) : 1;

      if(!(monthly>0) || !(sunH>0) || !(pvEff>0) || dayPct<0 || dayPct>1){
        alert('è«‹ç¢ºèªè¼¸å…¥æ•¸å€¼'); return;
      }
      if(TARIFF==='TOU' && (peakPct<0 || peakPct>1)){ alert('å³°æ™‚æ¯”ä¾‹ 0~100'); return; }

      const rates = getRates(monthly);

      // --- PV å®¹é‡ & é€†è®Šå™¨ ---
      const dailyKWh = monthly/30;
      const cap = dailyKWh / (sunH * pvEff);
      const inv = Math.ceil(cap*1.1*100)/100;

      // --- é›»æ± å®¹é‡ï¼ˆå¤œç”¨ +20% bufferï¼‰---
      const nightDaily = dailyKWh * (1 - dayPct);
      const batNeed = useBat ? round2(nightDaily / batEff * 1.2) : 0;

      // --- ç„¡ç³»çµ±å¸³å–® ---
      const bill0 = billRM(monthly, (TARIFF==='TOU' ? 'TOU' : 'NORMAL'), rates, peakPct);

      // --- PV ç™¼é›» ---
      const pvDaily   = cap * sunH * pvEff;
      const pvMonthly = pvDaily * 30;

      const dayUseM   = monthly * dayPct;
      const nightUseM = monthly - dayUseM;

      // ç™½å¤©å„ªå…ˆè‡ªç”¨ï¼Œå‰©é¤˜ç‚º excess
      const selfUse   = Math.min(pvMonthly, dayUseM);
      let excess      = Math.max(0, pvMonthly - dayUseM);

      // é›»æ± ç”¨å¤šé¤˜é›»å……ï¼Œå¤œé–“æ”¾é›»
      let batterySupply = 0;
      if(useBat){
        batterySupply = Math.min(excess * batEff, nightUseM);
        // è¢«é›»æ± æ‹¿å»å……çš„é›»é‡
        excess -= (batterySupply / batEff);
      }

      // å®‰è£å¾Œéœ€å‘é›»ç¶²è³¼é›»çš„ kWhï¼ˆæœªå¥—ç”¨ NEMï¼‰
      let gridAfter = monthly - (selfUse + batterySupply);

      // NEM ç°¡åŒ–ï¼šé¤˜é›» 1:1 æŠµæ‰£
      if(TARIFF==='NEM'){
        const nemOffset = Math.min(excess, gridAfter);
        gridAfter = Math.max(0, gridAfter - nemOffset);
      }

      // --- å®‰è£å¾Œå¸³å–®ï¼ˆä»¥å‰©é¤˜è³¼é›»é‡è¨ˆï¼‰---
      const modeForBill = (TARIFF==='TOU') ? 'TOU' : 'NORMAL';
      const bill1 = billRM(gridAfter, modeForBill, rates, peakPct);

      // --- è¼¸å‡º ---
      m('outCap').textContent   = round2(cap).toString();
      m('outInv').textContent   = round2(inv).toString();
      m('outBat').textContent   = useBat ? round2(batNeed).toString() : 'â€”';
      m('outBill0').textContent = fmtRM(bill0).replace('RM ','');
      m('outBill1').textContent = fmtRM(bill1).replace('RM ','');
      m('outSave').textContent  = fmtRM(Math.max(0, bill0 - bill1)).replace('RM ','');

      // é™„å¸¶debug
      m('debug').innerText =
        `æ¨¡å¼: ${TARIFF}\næœˆç”¨é›»: ${monthly} kWh\nPVæœˆç™¼é›»: ${round2(pvMonthly)} kWh\n`+
        `è‡ªç”¨: ${round2(selfUse)} kWh, é›»æ± ä¾›æ‡‰: ${round2(batterySupply)} kWh, é¤˜é›»: ${round2(excess)} kWh\n`+
        `è³¼é›»é‡(å®‰è£å¾Œ): ${round2(gridAfter)} kWh`;
    }

    // ç¶å®š
    document.getElementById('calcBtn').addEventListener('click', run);
    // é è¨­
    setTariff('NORMAL');
  </script>
</body>
</html>
